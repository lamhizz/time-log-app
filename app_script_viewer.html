<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WurkWurk - App Script Code</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,200,0,0" rel="stylesheet" />
  <style>
    :root {
      --wurk-primary: #52A2A0;
      --wurk-primary-hover: #428482;
      --wurk-secondary: #F4F4F4;
      --wurk-text-dark: #315558;
      --wurk-text-light: #6A8A8C;
      --work-log-border: #D1D5DB;
      --work-log-radius: 4px;
      --work-log-font: 'Montserrat', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }
    body {
      font-family: var(--work-log-font);
      margin: 0;
      padding: 20px;
      background-color: var(--wurk-secondary);
      color: var(--wurk-text-dark);
    }
    .material-symbols-outlined {
      font-weight: 200;
      font-size: 18px;
      vertical-align: middle;
      line-height: 1;
      font-variation-settings:
        'FILL' 0,
        'wght' 200,
        'GRAD' 0,
        'opsz' 20
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background-color: #fff;
      padding: 24px 32px;
      border-radius: var(--work-log-radius);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    .button {
      background-color: var(--wurk-primary);
      color: white;
      font-size: 14px;
      font-weight: 600;
      border: none;
      border-radius: var(--work-log-radius);
      padding: 10px 18px;
      cursor: pointer;
      transition: background-color 0.2s ease;
      font-family: inherit;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 20px;
    }
    .button:hover {
      background-color: var(--wurk-primary-hover);
    }
    pre {
      background-color: #F8F9FA;
      border: 1px solid #EAECEF;
      border-radius: var(--work-log-radius);
      padding: 12px;
      font-size: 13px;
      overflow-x: auto;
      line-height: 1.5;
    }
    code {
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="container">
    <button id="copy-script-btn" class="button">
      <span class="material-symbols-outlined">content_copy</span>
      Copy to Clipboard
    </button>
    
<pre id="apps-script-code"><code>/**
 * @file Google Apps Script for WurkWurk Chrome Extension (v3.3 with Caching)
 * @description This script receives data from the Chrome extension and logs it to a Google Sheet.
 * It also provides data for the dashboard and connection diagnostics.
 *
 * @changelog
 * v3.3: - Added CacheService to `getWeeklyData` to reduce Google Sheet API calls and avoid rate limits.
 * v3.2: - Added logic to reset 'Mins Since Last' to "N/A" on the first log of a new day.
 * v3.1: - Removed data processing from `getWeeklyData`. Now returns raw row data.
 */

// --- CONFIGURATION ---

/**
 * @const {string}
 * @description The current version of this Google Apps Script.
 */
const SCRIPT_VERSION = "3.3"; // <-- Updated version

/**
 * @const {string}
 * @description The time zone for formatting dates and times.
 * Find your time zone here: [https://en.wikipedia.org/wiki/List_of_tz_database_time_zones](https://en.wikipedia.org/wiki/List_of_tz_database_time_zones)
 * @example "America/New_York", "Europe/London", "Asia/Tokyo"
 */
const TIME_ZONE = "Europe/Vilnius"; // <<< SET YOUR TIME ZONE HERE

/**
 * @const {string}
 * @description The name of the sheet (the tab at the bottom) where logs will be added.
 * IMPORTANT: If you rename your sheet, you must update this value.
 */
const SHEET_NAME = "Sheet1";

// --- END CONFIGURATION ---


/**
 * @description Handles GET requests for connection testing, diagnostics, and dashboard data.
 * @param {object} e - The event parameter containing the request details.
 * @returns {ContentService.TextOutput} A JSON response.
 */
function doGet(e) {
  try {
    const action = e.parameter.action;

    // Action: Basic Test Connection
    if (action === "test") {
      Logger.log("WurkWurk: Received successful test ping.");
      return ContentService.createTextOutput(
        JSON.stringify({
          status: "success",
          message: "Connection successful!",
        })
      ).setMimeType(ContentService.MimeType.JSON);
    }

    // Action: Advanced Connection Diagnostics
    if (action === "diagnose") {
      const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
      if (!sheet) {
        throw new Error(`Sheet not found: ${SHEET_NAME}`);
      }
      // Get only the columns that have content in the first row
      const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];

      Logger.log("WurkWurk: Received successful diagnose ping.");
      return ContentService.createTextOutput(
        JSON.stringify({
          status: "success",
          version: SCRIPT_VERSION,
          headers: headers
        })
      ).setMimeType(ContentService.MimeType.JSON);
    }

    // Action: Get Weekly Data for Dashboard (with Caching)
    if (action === "getWeeklyData") {
      // --- NEW: Caching Logic ---
      const cache = CacheService.getScriptCache();
      const cacheKey = "dashboard_weekly_data";
      const cachedData = cache.get(cacheKey);

      if (cachedData != null) {
        Logger.log("WurkWurk: Returning cached weekly data.");
        return ContentService.createTextOutput(
          JSON.stringify({ status: "success", data: JSON.parse(cachedData) })
        ).setMimeType(ContentService.MimeType.JSON);
      }
      // --- END: Caching Logic ---

      Logger.log("WurkWurk: Fetching fresh weekly data from sheet.");
      const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
      if (!sheet) {
        throw new Error(`Sheet not found: ${SHEET_NAME}`);
      }
      const data = sheet.getDataRange().getValues();
      const header = data.shift(); // Remove header row

      const thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

      // Filter for recent data and convert to object array for dashboard.js
      const recentData = data.filter(row => new Date(row[6]) >= thirtyDaysAgo)
        .map(row => ({
          date: row[0],
          time: row[1],
          logEntry: row[2],
          tag: row[3],
          drifted: row[4] === "Yes",
          minutesSinceLast: row[5],
          timestamp: row[6],
          domain: row[7],
          reactive: row[8] === "Yes",
          keywords: row[9]
        }));

      // --- NEW: Store in cache ---
      // Cache for 10 minutes (600 seconds)
      cache.put(cacheKey, JSON.stringify(recentData), 600); 

      // --- Assemble Response ---
      return ContentService.createTextOutput(
        JSON.stringify({ status: "success", data: recentData })
      ).setMimeType(ContentService.MimeType.JSON);
    }

    // Fallback for unknown GET requests (like a redirect)
    return ContentService.createTextOutput(
      JSON.stringify({ status: "error", message: "Invalid GET request. Use POST to log data." })
    ).setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    Logger.log("WurkWurk: doGet Error - " + err.message);
    return ContentService.createTextOutput(
      JSON.stringify({ status: "error", message: err.message })
    ).setMimeType(ContentService.MimeType.JSON);
  }
}


/**
 * @description Handles POST requests from the Chrome extension to log new data.
 * @param {object} e - The event parameter containing the POST data.
 * @returns {ContentService.TextOutput} A JSON response indicating success or failure.
 */
function doPost(e) {
  let sheet;
  try {
    const data = JSON.parse(e.postData.contents);

    // --- [FIX] Handle POST-based diagnostic actions ---
    if (data.action === "test") {
      Logger.log("WurkWurk: Received successful test POST ping.");
      return ContentService.createTextOutput(
        JSON.stringify({ status: "success", message: "Connection successful!" })
      ).setMimeType(ContentService.MimeType.JSON);
    }

    if (data.action === "diagnose") {
      const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
      if (!sheet) {
        throw new Error(`Sheet not found: ${SHEET_NAME}`);
      }
      const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
      Logger.log("WurkWurk: Received successful diagnose POST ping.");
      return ContentService.createTextOutput(
        JSON.stringify({
          status: "success",
          version: SCRIPT_VERSION,
          headers: headers
        })
      ).setMimeType(ContentService.MimeType.JSON);
    }
    // --- [END FIX] ---

    // Original logging logic starts here
    const logEntry = data.log || "";
    const tag = data.tag || "";
    const drifted = data.drifted ? "Yes" : "No";
    const domain = data.domain || "";
    const reactive = data.reactive ? "Yes" : "No";
    const keywords = data.keywords || "";

    sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
    if (!sheet) {
      throw new Error(`Sheet not found. Please ensure a sheet named "${SHEET_NAME}" exists.`);
    }

    const now = new Date();
    const fullTimestamp = now.toISOString();
    // Get formatted date/time for the new log
    const dateFormatted = Utilities.formatDate(now, TIME_ZONE, "yyyy-MM-dd");
    const timeFormatted = Utilities.formatDate(now, TIME_ZONE, "HH:mm:ss");

    let minsSinceLast = "N/A";
    const lastRow = sheet.getLastRow();

    if (lastRow >= 1) {
      // Get the *date* (Col A) and *timestamp* (Col G) from the previous row
      // We read 7 columns (A to G)
      const lastRowData = sheet.getRange(lastRow, 1, 1, 7).getValues()[0];
      const lastDateFormatted = lastRowData[0]; // Column A is at index 0
      const lastTimestampStr = lastRowData[6]; // Column G is at index 6

      // Check if the last log was on the same day
      if (lastTimestampStr && lastDateFormatted === dateFormatted) {
        const lastTimestamp = new Date(lastTimestampStr);
        const diffMs = now.getTime() - lastTimestamp.getTime();
        minsSinceLast = Math.round(diffMs / 60000); // Convert milliseconds to minutes
      }
      // If it's a new day, minsSinceLast remains "N/A"
    }

    // The order MUST match your 10-column header setup in the sheet.
    const newRow = [
      dateFormatted,    // A: Date
      timeFormatted,    // B: Time
      logEntry,         // C: Log Entry
      tag,              // D: Tag
      drifted,          // E: Drifted
      minsSinceLast,    // F: Mins Since Last
      fullTimestamp,    // G: FullTimestamp
      domain,           // H: Domain
      reactive,         // I: Reactive
      keywords          // J: Keywords
    ];

    sheet.appendRow(newRow);
    
    // --- NEW: Invalidate dashboard cache on new log ---
    CacheService.getScriptCache().remove("dashboard_weekly_data");

    return ContentService.createTextOutput(
      JSON.stringify({ status: "success", row: sheet.getLastRow() })
    ).setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    Logger.log("WurkWurk: doPost Error - " + err.message);
    return ContentService.createTextOutput(
      JSON.stringify({ status: "error", message: err.message, sheetName: SHEET_NAME })
    ).setMimeType(ContentService.MimeType.JSON);
  }
}
</code></pre>
  </div>

  <script>
    document.getElementById('copy-script-btn').addEventListener('click', () => {
      const codeEl = document.getElementById('apps-script-code');
      const copyButton = document.getElementById('copy-script-btn');
      const code = codeEl.innerText;

      const textArea = document.createElement("textarea");
      textArea.value = code;
      textArea.style.position = "fixed";
      textArea.style.top = "0";
      textArea.style.left = "0";
      textArea.style.opacity = "0";
      document.body.appendChild(textArea);
      
      textArea.focus();
      textArea.select();

      try {
        const successful = document.execCommand('copy');
        if (successful) {
          copyButton.innerHTML = `<span class="material-symbols-outlined">check</span> Copied!`;
          setTimeout(() => {
            copyButton.innerHTML = `<span class="material-symbols-outlined">content_copy</span> Copy to Clipboard`;
          }, 2000);
        } else {
          copyButton.textContent = "Failed to copy";
        }
      } catch (err) {
        console.error('Failed to copy script: ', err);
        copyButton.textContent = "Failed to copy";
      }

      document.body.removeChild(textArea);
    });
  </script>
</body>
</html>
