<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-R">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WurkWurk Setup Guide</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --wurk-primary: #52A2A0;
      --wurk-primary-hover: #428482;
      --wurk-secondary: #F4F4F4;
      --wurk-text-dark: #315558;
      --wurk-text-light: #6A8A8C;
      --work-log-border: #D1D5DB;
      --work-log-radius: 4px;
      --work-log-font: 'Montserrat', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }
    body {
      font-family: var(--work-log-font);
      margin: 0;
      padding: 20px;
      background-color: var(--wurk-secondary);
      color: var(--wurk-text-dark);
      min-width: 400px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .container {
      max-width: 650px;
      margin: 0 auto;
      background-color: #fff;
      padding: 24px 32px;
      border-radius: var(--work-log-radius);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    img.logo {
      width: 120px; 
      display: block; 
      margin: 0 auto 10px; 
      opacity: 0.8;
    }
    h1, h2, h3 {
      color: var(--wurk-text-dark);
      font-weight: 600;
    }
    h1 {
      text-align: center;
      font-size: 22px;
      margin: 0 0 20px 0;
    }
    h2 {
      font-size: 18px;
      margin-top: 24px;
      border-bottom: 1px solid var(--wurk-secondary);
      padding-bottom: 5px;
    }
    h3 {
      font-size: 16px;
      margin-top: 20px;
      color: var(--wurk-primary);
    }
    p, li {
      font-size: 14px;
      line-height: 1.6;
      color: var(--wurk-text-dark);
    }
    ul, ol {
      padding-left: 20px;
    }
    pre {
      background-color: #F8F9FA;
      border: 1px solid #EAECEF;
      border-radius: var(--work-log-radius);
      padding: 12px;
      font-size: 13px;
      overflow-x: auto;
      line-height: 1.5;
    }
    code {
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
      font-size: 13px;
    }
    pre code {
      color: #333;
    }
    p > code, li > code {
      background-color: #EAEAEA;
      color: #D6336C;
      padding: 2px 5px;
      border-radius: 3px;
      font-weight: 600;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
      font-size: 13px;
      border: 1px solid var(--work-log-border);
    }
    th, td {
      border: 1px solid var(--work-log-border);
      padding: 8px 10px;
      text-align: left;
    }
    th {
      background-color: var(--wurk-secondary);
      font-weight: 600;
    }
    strong {
      color: var(--wurk-text-dark);
      font-weight: 600;
    }
    .links {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--wurk-secondary);
    }
    .links a {
      font-family: inherit;
      font-size: 14px;
      font-weight: 500;
      border: 1px solid var(--work-log-border);
      border-radius: var(--work-log-radius);
      padding: 8px 14px;
      cursor: pointer;
      text-decoration: none;
      color: var(--wurk-text-dark);
      background-color: #fff;
    }
    .links a:hover {
      background-color: var(--wurk-secondary);
    }
  </style>
</head>
<body>

  <div class="container">
    <img src="images/wurk-wurk-logo.png" alt="WurkWurk Logo" class="logo">
    <h1>WurkWurk Setup Guide</h1>

    <p>This guide provides step-by-step instructions to connect the WurkWurk Chrome extension to your own private Google Sheet.</p>

    <h2>Step 1: Create Your Google Sheet</h2>
    <ol>
      <li>Go to <a href="https://sheets.google.com" target="_blank">sheets.google.com</a>.</li>
      <li>Click on <strong>Blank</strong> to create a new spreadsheet.</li>
      <li>Give the spreadsheet a name you'll remember, like "My WurkWurk Logs."</li>
    </ol>

    <h2>Step 2: Add Headers to the Sheet</h2>
    <p>This is a critical step. The script requires nine specific headers in the first row, in this exact order, to function correctly.</p>

    <table>
      <thead>
        <tr>
          <th>A1</th>
          <th>B1</th>
          <th>C1</th>
          <th>D1</th>
          <th>E1</th>
          <th>F1</th>
          <th>G1</th>
          <th>H1</th>
          <th>I1</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Date</td>
          <td>Time</td>
          <td>Log Entry</td>
          <td>Tag</td>
          <td>Drifted</td>
          <td>Mins Since Last</td>
          <td>FullTimestamp</td>
          <td>Domain</td>
          <td>Reactive</td>
        </tr>
      </tbody>
    </table>

    <ol>
      <li>In cell <strong>A1</strong>, type: <code>Date</code></li>
      <li>In cell <strong>B1</strong>, type: <code>Time</code></li>
      <li>In cell <strong>C1</strong>, type: <code>Log Entry</code></li>
      <li>In cell <strong>D1</strong>, type: <code>Tag</code></li>
      <li>In cell <strong>E1</strong>, type: <code>Drifted</code></li>
      <li>In cell <strong>F1</strong>, type: <code>Mins Since Last</code></li>
      <li>In cell <strong>G1</strong>, type: <code>FullTimestamp</code></li>
      <li>In cell <strong>H1</strong>, type: <code>Domain</code></li>
      <li>In cell <strong>I1</strong>, type: <code>Reactive</code></li>
    </ol>

    <h2>Step 3: Create the Google Apps Script</h2>
    <p>This script will act as the secure bridge between the Chrome extension and your Google Sheet.</p>
    <ol>
      <li>In your Google Sheet, click <strong>Extensions</strong> > <strong>Apps Script</strong>.</li>
      <li>A new browser tab will open with the Apps Script editor.</li>
    </ol>

    <h2>Step 4: Paste the Script Code</h2>
    <ol>
      <li>Delete any placeholder code in the <code>Code.gs</code> file (e.g., <code>function myFunction() { ... }</code>).</li>
      <li>Copy the entire script below and paste it into the empty <code>Code.gs</code> editor.</li>
    </ol>
<pre><code>/**
 * @file Google Apps Script for WurkWurk Chrome Extension (v2.2)
 * @description This script receives data from the Chrome extension and logs it to a Google Sheet.
 * It handles a 9-column layout and includes a test function.
 */

// --- CONFIGURATION ---

/**
 * @const {string}
 * @description The time zone for formatting dates and times.
 * Find your time zone here: https://en.wikipedia.org/wiki/List_of_tz_database_time_zones
 * @example "America/New_York", "Europe/London", "Asia/Tokyo"
 */
const TIME_ZONE = "Europe/Vilnius";

/**
 * @const {string}
 * @description The name of the sheet (the tab at the bottom) where logs will be added.
 * IMPORTANT: If you rename your sheet, you must update this value.
 */
const SHEET_NAME = "Sheet1";

// --- END CONFIGURATION ---


/**
 * @description Handles GET requests. This is used by the extension's "Test Connection" button.
 * @param {object} e - The event parameter containing the request details.
 * @returns {ContentService.TextOutput} A JSON response indicating success or failure.
 */
function doGet(e) {
  try {
    if (e.parameter.action === "test") {
      Logger.log("WurkWurk: Received successful test ping.");
      return ContentService.createTextOutput(
        JSON.stringify({
          status: "success",
          message: "Connection successful!",
        })
      ).setMimeType(ContentService.MimeType.JSON);
    }
  } catch (err) {
    Logger.log("WurkWurk: doGet Error - " + err.message);
    return ContentService.createTextOutput(
      JSON.stringify({ status: "error", message: err.message })
    ).setMimeType(ContentService.MimeType.JSON);
  }
  
  // Return an error for any other GET request
  return ContentService.createTextOutput(
    JSON.stringify({ status: "error", message: "Invalid request. Use POST to log data." })
  ).setMimeType(ContentService.MimeType.JSON);
}


/**
 * @description Handles POST requests from the Chrome extension to log new data.
 * @param {object} e - The event parameter containing the POST data.
 * @returns {ContentService.TextOutput} A JSON response indicating success or failure.
 */
function doPost(e) {
  let sheet;
  try {
    // 1. Parse incoming data from the extension
    const data = JSON.parse(e.postData.contents);
    const logEntry = data.log || "";
    const tag = data.tag || "";
    const drifted = data.drifted ? "Yes" : "No";
    const domain = data.domain || "";
    const reactive = data.reactive ? "Yes" : "No";
    
    // 2. Get the target sheet and current time
    sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
    if (!sheet) {
      throw new Error(`Sheet not found. Please ensure a sheet named "${SHEET_NAME}" exists.`);
    }
    
    const now = new Date();
    const fullTimestamp = now.toISOString(); // ISO format for accurate calculations
    const dateFormatted = Utilities.formatDate(now, TIME_ZONE, "yyyy-MM-dd");
    const timeFormatted = Utilities.formatDate(now, TIME_ZONE, "HH:mm:ss");

    // 3. Calculate the time difference since the last log
    let minsSinceLast = "N/A";
    const lastRow = sheet.getLastRow();
    
    if (lastRow >= 1) {
      // Column G (index 7) is FullTimestamp
      const lastTimestampStr = sheet.getRange(lastRow, 7).getValue(); 
      if (lastTimestampStr) {
        const lastTimestamp = new Date(lastTimestampStr);
        const diffMs = now.getTime() - lastTimestamp.getTime();
        minsSinceLast = Math.round(diffMs / 60000); // Convert milliseconds to minutes
      }
    }

    // 4. Prepare and append the new row
    // The order MUST match your 9-column header setup in the sheet.
    const newRow = [
      dateFormatted,    // A: Date
      timeFormatted,    // B: Time
      logEntry,         // C: Log Entry
      tag,              // D: Tag
      drifted,          // E: Drifted
      minsSinceLast,    // F: Mins Since Last
      fullTimestamp,    // G: FullTimestamp
      domain,           // H: Domain
      reactive          // I: Reactive
    ];
    
    sheet.appendRow(newRow);

    // 5. Return a success response to the extension
    return ContentService.createTextOutput(
      JSON.stringify({ status: "success", row: sheet.getLastRow() })
    ).setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    // 6. Log the error and return an error response
    Logger.log("WurkWurk: doPost Error - " + err.message);
    return ContentService.createTextOutput(
      JSON.stringify({ status: "error", message: err.message, sheetName: SHEET_NAME })
    ).setMimeType(ContentService.MimeType.JSON);
  }
}
</code></pre>
    <ol start="3">
      <li>
        <strong>IMPORTANT</strong>: Find the line <code>const TIME_ZONE = "Europe/Vilnius";</code> and change the time zone to your own (e.g., <code>"America/New_York"</code>).
      </li>
      <li>Save the script by clicking the floppy disk icon or pressing <code>Ctrl+S</code>.</li>
    </ol>

    <h2>Step 5: Deploy the Script as a Web App</h2>
    <p>This step creates the secret URL the extension will use to send data to your sheet.</p>
    <ol>
      <li>In the Apps Script editor, click the blue <strong>Deploy</strong> button in the top-right corner.</li>
      <li>Select <strong>New deployment</strong>.</li>
      <li>Click the gear icon (⚙️) next to "Select type" and choose <strong>Web app</strong>.</li>
      <li>In the dialog box, enter the following settings:
        <ul>
          <li><strong>Description</strong>: <code>WurkWurk Log Receiver</code> (Optional)</li>
          <li><strong>Execute as</strong>: <code>Me</code> (This is very important).</li>
          <li><strong>Who has access</strong>: <code>Anyone</code> (This does NOT make your sheet public. It only allows someone with the secret, complex URL to send data to the script).</li>
        </ul>
      </li>
      <li>Click <strong>Deploy</strong>.</li>
    </ol>

    <h2>Step 6: Authorize the Script</h2>
    <ol>
      <li>Google will prompt you to authorize the script. Click <strong>Authorize access</strong>.</li>
      <li>Choose your Google account.</li>
      <li>You will likely see a "Google hasn't verified this app" warning. This is normal for personal scripts. Click <strong>Advanced</strong>, then click <strong>"Go to [Your Script Name] (unsafe)"</strong>.</li>
      <li>Click <strong>Allow</strong> to grant the script permission to edit your spreadsheets.</li>
    </ol>

    <h2>Step 7: Copy the Web App URL</h2>
    <p>After deployment is complete, a dialog box will appear with the <strong>Web app URL</strong>.</p>
    <p><strong>COPY THIS URL.</strong> You will need it for the final step.</p>

    <h2>Step 8: Configure the Extension</h2>
    <ol>
      <li>Go to your Chrome extensions page by navigating to <code>chrome://extensions</code>.</li>
      <li>Find the "WurkWurk" extension.</li>
      <li>Right-click the extension's icon in your Chrome toolbar and click <strong>Options</strong>.</li>
      <li>On the settings page:
        <ul>
          <li>Paste the <strong>Web app URL</strong> you copied into the first field, "Google Apps Script URL."</li>
          <li>Click the <strong>Test</strong> button next to it. You should see a green "Success!" message. If not, double-check your script deployment and URL.</li>
          <li>Configure your other preferences, such as the log interval and notification sound.</li>
        </ul>
      </li>
      <li>Scroll to the bottom and click <strong>Save Settings</strong>.</li>
    </ol>
    <p>You are all set! The extension is now fully configured and will start prompting you at your chosen interval during your working hours.</p>

    <div class="links">
      <a href="#" id="open-settings">Back to Settings</a>
    </div>
  </div>

  <script>
    document.getElementById('open-settings').addEventListener('click', (e) => {
      e.preventDefault();
      chrome.runtime.openOptionsPage();
    });
  </script>

</body>
</html>

